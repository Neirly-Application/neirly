<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neirly - Home</title>
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    integrity="sha512-..."
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <link rel="stylesheet" href="./main.css" />
  <link rel="stylesheet" href="../styles/offline.css" />
  <link rel="stylesheet" href="../styles/manageMain.css" />
  <link rel="stylesheet" href="../styles/map.css" />
  <link rel="stylesheet" href="../styles/themes.css" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>


  <link rel="icon" type="image/png" sizes="16x16" href="/media/neirly.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/media/neirly.png">
  <link rel="icon" type="image/png" sizes="48x48" href="/media/neirly.png">
  <link rel="icon" type="image/x-icon" href="/media/neirly.png">
</head>

<body>
  <button class="mobile-toggle" aria-label="Toggle Menu">
    <i class="fas fa-bars"></i>
  </button>

  <div class="mobile-topbar">
    <div class="topbar-left">
      <img src="../media/neirly.png" alt="Neirly Logo" class="topbar-logo" />
      <span class="topbar-title">Neirly</span>
    </div>
    <div class="topbar-menu">
      <a href="#notifications" class="nav-item" title="Notifications" data-section="notifications">
        <i class="fas fa-bell">
          <span class="notification-badge"></span>
        </i>
      </a>
      <button class="menu-button" title="Options">
        <i class="fas fa-ellipsis-v"></i>
      </button>
      <div class="menu-dropdown">        
        <a href="#ceo" class="nav-item" data-section="ceo" id="admin-section" style="display:none;">
          <i class="fas fa-user-shield"></i> Actions
        </a>
        <a href="#friend-list" data-section="friend-list" class="nav-item">
          <i class="fas fa-user-friends"></i> Friends
        </a>
        <a href="#profile" data-section="profile" class="nav-item">
          <i class="fas fa-user"></i> Profile
        </a>
        <a href="#settings-devices" data-section="settings-devices" class="nav-item">
          <i class="fas fa-laptop"></i> Devices
        </a>
        <a href="#settings" data-section="settings" class="nav-item">
          <i class="fas fa-cog"></i> Settings 
        </a>
        <a href="/privacy-policy" class="nav-item">
          <i class="fas fa-file-alt"></i> Policies
        </a>
        <a href="#logout" class="nav-item logout-btn" id="logout-btn">
          <i class="fas fa-sign-out-alt"></i>  Logout
        </a>
      </div>
    </div>
  </div>

  <nav class="sidebar">
    <div class="nav-header">
      <img src="../media/neirly.png" alt="Neirly Logo" class="nav-logo" />
          <div id="welcomeMessage"></div>
    </div>
    
    <div class="nav-links">
      <a href="#map" class="nav-item active" data-section="map">
        <i class="fas fa-map"></i> 
        <span>Map</span>
        </a>
      </a>
      <a href="#friend-list" class="nav-item" data-section="friend-list">
        <i class="fas fa-user-friends"></i>
        <span>Friends</span>
      </a>
      <a href="#notifications" class="nav-item" data-section="notifications">
        <i class="fas fa-bell"></i>
        <span>Notifications</span>
        <span class="notification-badge"></span>
      </a>
      <a href="#messages" class="nav-item" data-section="messages">
        <i class="fas fa-comment-alt"></i> 
        <span>Messagges</span>
      </a>
      <a href="#profile" class="nav-item" data-section="profile">
        <i class="fas fa-user"></i> 
        <span>Profile</span>
      </a>
      <a href="#ceo" class="nav-item" data-section="ceo" id="admin-section" style="display:none;">
        <i class="fas fa-user-shield"></i> 
        <span>Actions</span>
      </a>
    </div>

    <div class="nav-footer">
      <a href="/privacy-policy" class="nav-item">
        <i class="fas fa-file-alt"></i>
        <span>Policies</span>
      </a>
      <a href="#settings" class="nav-item settings" data-section="settings">
        <i class="fas fa-cog"></i> 
        <span>Settings</span>
      </a>
      <a href="#logout" class="nav-item logout-btn" id="logout-btn">
        <i class="fas fa-sign-out-alt"></i> 
        <span>Logout</span>
      </a>
    </div>
  </nav>

  <nav class="bottom-navbar">
    <a href="#map" class="nav-item" data-section="map">
      <i class="fas fa-map"></i>
    </a>
    <a href="#messages" class="nav-item" data-section="messages">
      <i class="fas fa-comment-alt"></i>
    </a>
    <a href="#profile" class="nav-item" data-section="profile">
      <i class="fas fa-user"></i>
    </a>
  </nav>

  <main class="content"></main>

  <div id="offlineOverlay" style="display:none;">
    <div class="offline-content">
      <img src="../media/offline.png" alt="Offline" />
      <h1>No internet connection.</h1>
      <p>Check your connection and try again.</p>
    </div>
  </div>

  <div id="custom-confirm-overlay" class="confirm-overlay" style="display:none;">
    <div class="confirm-box">
      <div class="confirm-header">
        <img src="../media/handstop.png" alt="Alert Icon" class="confirm-icon" aria-hidden="true">
        <h2 id="confirm-title">Oop... wait a second...</h2>
      </div>
      <p id="confirm-message">Are you sure?</p>
      <div class="confirm-buttons">
        <button id="confirm-yes" class="btn-confirm yes">Confirm</button>
        <button id="confirm-no" class="btn-confirm no">Dismiss</button>
      </div>
    </div>
  </div>

  <div id="custom-toast-container" class="toast-container"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="../scripts/manageMain.js"></script>
  <script src="../scripts/offline.js"></script>
  <script src="../scripts/notification.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sections = ['map', 'messages', 'profile', 'friend-list'];
    let touchStartX = 0;
    let touchEndX = 0;
    let swipeActive = false;
    let resizeTimeout;

    function updateActiveNavItem(section) {
      document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
      });
      document.querySelectorAll(`.nav-item[data-section="${section}"]`).forEach(el => {
        el.classList.add('active');
      });
    }

    function isMobile() {
      return window.innerWidth <= 768;
    }

    function getCurrentSectionIndex() {
      const hash = window.location.hash.replace('#', '');
      const index = sections.indexOf(hash);
      return index !== -1 ? index : -1;
    }

    function handleSwipeNavigation() {
      const currentIndex = getCurrentSectionIndex();
      if (currentIndex === -1) return;

      const direction = touchEndX < touchStartX ? 1 : -1;
      const nextIndex = currentIndex + direction;

      if (nextIndex >= 0 && nextIndex < sections.length) {
        window.location.hash = `#${sections[nextIndex]}`;
      }
    }

    function onTouchStart(e) {
      touchStartX = e.changedTouches[0].screenX;
    }

    function onTouchEnd(e) {
      touchEndX = e.changedTouches[0].screenX;
      if (Math.abs(touchEndX - touchStartX) > 50) {
        handleSwipeNavigation();
      }
    }

    function enableSwipe() {
      if (!swipeActive) {
        document.addEventListener('touchstart', onTouchStart);
        document.addEventListener('touchend', onTouchEnd);
        swipeActive = true;
      }
    }

    function disableSwipe() {
      if (swipeActive) {
        document.removeEventListener('touchstart', onTouchStart);
        document.removeEventListener('touchend', onTouchEnd);
        swipeActive = false;
      }
    }

    function checkScreenSize() {
      if (isMobile()) {
        enableSwipe();
      } else {
        disableSwipe();
      }
    }

    // Debounced resize handler
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(checkScreenSize, 150);
    });

    // Default to 'map' if no hash
    if (!location.hash) {
      location.hash = '#map';
    }

    // Initial nav activation and swipe setup
    updateActiveNavItem(location.hash.replace('#', ''));
    checkScreenSize();

    // Update nav item on hash change
    window.addEventListener('hashchange', () => {
      const section = location.hash.replace('#', '') || 'map';
      updateActiveNavItem(section);
    });

    // Click handler for bottom navbar
    document.querySelectorAll('.bottom-navbar .nav-item').forEach(link => {
      link.addEventListener('click', (e) => {
        const targetHash = link.getAttribute('href');
        if (targetHash) {
          location.hash = targetHash;
        }
      });
    });

    // Dropdown menu toggle
    document.addEventListener('click', function (e) {
      const btn = document.querySelector('.menu-button');
      const dropdown = document.querySelector('.menu-dropdown');

      if (!btn || !dropdown) return;

      const isClickOnButton = btn.contains(e.target);
      const isClickInsideDropdown = dropdown.contains(e.target);

      if (isClickOnButton) {
        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
          dropdown.classList.add('hide');
          setTimeout(() => {
            if (!dropdown.classList.contains('show')) {
              dropdown.style.display = 'none';
            }
          }, 250);
        } else {
          dropdown.style.display = 'flex';
          requestAnimationFrame(() => {
            dropdown.classList.remove('hide');
            dropdown.classList.add('show');
          });
        }
      } else if (!isClickInsideDropdown) {
        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
          dropdown.classList.add('hide');
          setTimeout(() => {
            if (!dropdown.classList.contains('show')) {
              dropdown.style.display = 'none';
            }
          }, 250);
        }
      }
    });

    // Dropdown nav item click
    document.querySelectorAll('.menu-dropdown .nav-item').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetHash = link.getAttribute('href');
        if (targetHash) {
          location.hash = targetHash;
        }

        const dropdown = document.querySelector('.menu-dropdown');
        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
          dropdown.classList.add('hide');
          setTimeout(() => {
            if (!dropdown.classList.contains('show')) {
              dropdown.style.display = 'none';
            }
          }, 250);
        }
      });
    });
  });
</script>

<script>
    function updateBottomNavbar() {
      const navbar = document.querySelector('.bottom-navbar');

      if (!navbar) return;

      let extraItem = navbar.querySelector('.nav-item.extra');

      if (window.innerWidth >= 440) {
        if (!extraItem) {
          const newItem = document.createElement('a');
          newItem.href = '#friend-list';
          newItem.classList.add('nav-item', 'extra');
          newItem.dataset.section = 'friend-list';
          newItem.innerHTML = '<i class="fas fa-user-friends"></i>';
          navbar.appendChild(newItem);
        }
      } else {
        if (extraItem) extraItem.remove();
      }
    }

    window.addEventListener('DOMContentLoaded', updateBottomNavbar);
    window.addEventListener('resize', updateBottomNavbar);
</script>
</body>
</html>
